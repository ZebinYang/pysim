

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pysim.simboost &mdash; pysim  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pysim
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pysim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pysim.simboost</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pysim.simboost</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">gridspec</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">MaxNLocator</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="k">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.extmath</span> <span class="k">import</span> <span class="n">softmax</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="k">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="k">import</span> <span class="n">check_X_y</span><span class="p">,</span> <span class="n">column_or_1d</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="k">import</span> <span class="n">check_is_fitted</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">RidgeCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">make_scorer</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">PredefinedSplit</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">LabelBinarizer</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="k">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">is_classifier</span><span class="p">,</span> <span class="n">is_regressor</span>

<span class="kn">from</span> <span class="nn">.sim</span> <span class="k">import</span> <span class="n">SimRegressor</span><span class="p">,</span> <span class="n">SimClassifier</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SimBoostRegressor&quot;</span><span class="p">,</span> <span class="s2">&quot;SimBoostRegressor&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BaseSimBooster</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_estimators</span><span class="p">,</span> <span class="n">stein_method</span><span class="o">=</span><span class="s2">&quot;first_order&quot;</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="s2">&quot;a_spline&quot;</span><span class="p">,</span> <span class="n">knot_dist</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reg_lambda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">reg_gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">knot_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">ortho_shrink</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loss_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">inner_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">meta_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="n">n_estimators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span> <span class="o">=</span> <span class="n">stein_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spline</span> <span class="o">=</span> <span class="n">spline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span> <span class="o">=</span> <span class="n">reg_lambda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span> <span class="o">=</span> <span class="n">reg_gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knot_dist</span> <span class="o">=</span> <span class="n">knot_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span> <span class="o">=</span> <span class="n">knot_num</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ortho_shrink</span> <span class="o">=</span> <span class="n">ortho_shrink</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_threshold</span> <span class="o">=</span> <span class="n">loss_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_update</span> <span class="o">=</span> <span class="n">inner_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span> <span class="o">=</span> <span class="n">meta_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span> <span class="o">=</span> <span class="n">val_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>        

    <span class="k">def</span> <span class="nf">_validate_hyperparameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;method to validate model parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_estimators must be an integer, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_estimators must be &gt;= 0, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;first_order&quot;</span><span class="p">,</span> <span class="s2">&quot;second_order&quot;</span><span class="p">,</span> <span class="s2">&quot;first_order_thres&quot;</span><span class="p">,</span> <span class="s2">&quot;ols&quot;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method must be an element of [first_order, second_order, first_order_thres, ols], got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stein_method_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span>  
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;first_order&quot;</span><span class="p">,</span> <span class="s2">&quot;second_order&quot;</span><span class="p">,</span> <span class="s2">&quot;first_order_thres&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method must be an element of [first_order, second_order, first_order_thres, ols], got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stein_method_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stein_method</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a_spline&quot;</span><span class="p">,</span> <span class="s2">&quot;smoothing_spline&quot;</span><span class="p">,</span> <span class="s2">&quot;p_spline&quot;</span><span class="p">,</span> <span class="s2">&quot;mono_p_spline&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;spline must be an element of [a_spline, smoothing_spline, p_spline, mono_p_spline], got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;learning_rate must be &gt; 0, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;learning_rate must be &lt;= 1, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;all the elements in reg_lambda must be &gt;= 0, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span>  
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reg_lambda must be &gt;= 0 and &lt;=1, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;all the elements in reg_gamma must be &gt;= 0, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span>  
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;all the elements in reg_gamma must be &gt;= 0, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;degree must be an integer, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;degree must be &gt;= 0, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;knot_num must be an integer, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;knot_num must be &gt; 0, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">knot_dist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;quantile&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method must be an element of [uniform, quantile], got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">knot_dist</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_update</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;inner_update must be an integer, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_update</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;meta_info must be a dict, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;val_ratio must be &gt; 0, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;val_ratio must be &lt; 1, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span><span class="p">)</span>
  
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">importance_ratios_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the estimator importance ratios (the higher, the more important the feature)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of selected estimators</span>
<span class="sd">            the importance ratio of each fitted base learner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">importance_ratios_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_importance_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_importance_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">total_importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_importance_</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="n">importance_ratios_</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;indice&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;indice&quot;</span><span class="p">],</span>
                               <span class="s2">&quot;ir&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_importance</span><span class="p">}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_importance_</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">importance_ratios_</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projection_indices_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the projection indices</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray of shape (n_features, n_estimators)</span>
<span class="sd">            the projection indices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">projection_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">projection_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">est</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">beta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> 
                                    <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="k">if</span> <span class="s2">&quot;sim&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">projection_indices</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">orthogonality_measure_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the orthogonality measure (the lower, the better)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            the orthogonality measure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ortho_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ortho_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ortho_measure</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ortho_measure</span>

    <span class="k">def</span> <span class="nf">_validate_sample_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">):</span>
                
        <span class="sd">&quot;&quot;&quot;method to validate sample weight</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        n_samples : int</span>
<span class="sd">            the number of samples</span>
<span class="sd">        sample_weight : array-like of shape (n_samples,), optional</span>
<span class="sd">            containing sample weights</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample_weight</span>
    
    <span class="k">def</span> <span class="nf">_preprocess_meta_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;preprocess the meta info of the dataset</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        n_features : int</span>
<span class="sd">            the number of features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_features</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;X&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;continuous&quot;</span><span class="p">}})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;target&quot;</span><span class="p">}})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;meta_info must be None or a dict, got&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span> <span class="o">=</span> <span class="p">{}</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_list_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_list_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_list_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_index_list_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">feature_info</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">feature_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">feature_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_index_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">feature_name</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_features</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;meta_info and n_features mismatch!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validation_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;draw the validation accuracy (regression and AUC for binary classification) against the number of base learners</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;best_estimators_&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_regressor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">),</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Estimators&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Validation MSE&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">),</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Estimators&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Validation AUC&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols_per_row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./results/&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;global_plot&quot;</span><span class="p">,</span> <span class="n">save_png</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_eps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;draw the global interpretation of the fitted model</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        cols_per_row : int, optional, default=3,</span>
<span class="sd">            the number of sim models visualized on each row</span>
<span class="sd">        folder : str, optional, defalut=&quot;./results/&quot;</span>
<span class="sd">            the folder of the file to be saved</span>
<span class="sd">        name : str, optional, default=&quot;global_plot&quot;</span>
<span class="sd">            the name of the file to be saved</span>
<span class="sd">        save_png : bool, optional, default=False</span>
<span class="sd">            whether to save the figure in png form</span>
<span class="sd">        save_eps : bool, optional, default=False</span>
<span class="sd">            whether to save the figure in eps form</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;best_estimators_&quot;</span><span class="p">)</span>

        <span class="n">subfig_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">cols_per_row</span><span class="p">,</span> <span class="mf">4.6</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_ids</span> <span class="o">/</span> <span class="n">cols_per_row</span><span class="p">))))</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_ids</span> <span class="o">/</span> <span class="n">cols_per_row</span><span class="p">)),</span> <span class="n">cols_per_row</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xlim_min</span> <span class="o">=</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>
            <span class="n">xlim_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_indices_</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">):</span>
            
            <span class="n">estimator_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importance_ratios_</span><span class="p">)[</span><span class="n">indice</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;sim&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="n">est</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="n">outer</span><span class="p">[</span><span class="n">subfig_idx</span><span class="p">]</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">ax1_main</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">inner</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">ygrid</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>
                <span class="n">ax1_main</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">ax1_main</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax1_main</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SIM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importance_ratios_</span><span class="p">[</span><span class="n">estimator_key</span><span class="p">][</span><span class="s2">&quot;indice&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot; (IR: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">importance_ratios_</span><span class="p">[</span><span class="n">estimator_key</span><span class="p">][</span><span class="s2">&quot;ir&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;%)&quot;</span><span class="p">,</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1_main</span><span class="p">)</span>

                <span class="n">ax1_density</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">inner</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  
                <span class="n">xint</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">bins_</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">bins_</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax1_density</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xint</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">density_</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">xint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ax1_main</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ax1_main</span><span class="p">,</span> <span class="n">ax1_density</span><span class="p">)</span>
                <span class="n">ax1_density</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1_density</span><span class="p">)</span>

                <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">inner</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">rects</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="p">)),</span> <span class="p">[</span><span class="n">beta</span> <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="p">)))</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;X&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim_min</span><span class="p">,</span> <span class="n">xlim_max</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="p">))</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">active_beta</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">active_beta_idx</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">active_beta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
                            <span class="n">active_beta_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">rects</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_beta</span><span class="p">)),</span> <span class="p">[</span><span class="n">beta</span> <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">active_beta</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_beta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">input_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_beta</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_beta</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">[</span><span class="n">active_beta_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">input_ticks</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">input_ticks</span><span class="p">)</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">input_labels</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_beta</span><span class="p">)))</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;X&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">active_beta_idx</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim_min</span><span class="p">,</span> <span class="n">xlim_max</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_beta_idx</span><span class="p">))</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
                <span class="n">subfig_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                
        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">):</span>

            <span class="k">if</span> <span class="s2">&quot;dummy_lr&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">feature_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dummy_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_density_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;density&quot;</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
                <span class="n">dummy_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_density_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;density&quot;</span><span class="p">][</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
                <span class="n">dummy_coef</span> <span class="o">=</span> <span class="n">est</span><span class="p">[</span><span class="s2">&quot;dummy_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span>

                <span class="n">ax_main</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">outer</span><span class="p">[</span><span class="n">subfig_idx</span><span class="p">])</span>
                <span class="n">ax_density</span> <span class="o">=</span> <span class="n">ax_main</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">ax_density</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">)),</span> <span class="n">dummy_scores</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                <span class="n">ax_density</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dummy_scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
                <span class="n">ax_density</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

                <span class="n">input_ticks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span> 
                                  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                <span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_ticks</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">))))</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">[</span><span class="n">i</span><span class="p">])[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_ticks</span><span class="p">]</span>

                <span class="n">ax_main</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">input_ticks</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">input_labels</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dummy_coef</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dummy_coef</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">)),</span> <span class="n">dummy_coef</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feature_name</span> <span class="o">+</span>
                                 <span class="s2">&quot; (IR: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">importance_ratios_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;ir&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="n">ax_density</span><span class="o">.</span><span class="n">get_zorder</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">ax_main</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">subfig_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">save_png</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span>
                <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_eps</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span>
                <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.eps&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">local_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./results/&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;local_plot&quot;</span><span class="p">,</span> <span class="n">save_png</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_eps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;draw the local interpretation of the fitted model</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        cols_per_row : int, optional, default=3,</span>
<span class="sd">            the number of sim models visualized on each row</span>
<span class="sd">        folder : str, optional, defalut=&quot;./results/&quot;</span>
<span class="sd">            the folder of the file to be saved</span>
<span class="sd">        name : str, optional, default=&quot;global_plot&quot;</span>
<span class="sd">            the name of the file to be saved</span>
<span class="sd">        save_png : bool, optional, default=False</span>
<span class="sd">            whether to save the figure in png form</span>
<span class="sd">        save_eps : bool, optional, default=False</span>
<span class="sd">            whether to save the figure in eps form</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ytick_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>
        <span class="n">max_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;sim&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">estimator_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importance_ratios_</span><span class="p">)[</span><span class="n">indice</span><span class="p">]</span>
                <span class="n">ytick_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;SIM &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importance_ratios_</span><span class="p">[</span><span class="n">estimator_key</span><span class="p">][</span><span class="s2">&quot;indice&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;dummy_lr&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">feature_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ytick_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_regressor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">max_ids</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_ids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_ids</span><span class="p">),</span> <span class="n">ytick_label</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Predicted: </span><span class="si">%0.4f</span><span class="s2"> | Actual: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Predicted: </span><span class="si">%0.4f</span><span class="s2">&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">save_eps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.eps&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">save_png</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">feature_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            
        <span class="sd">&quot;&quot;&quot;calculate gradients of the fitted model to the input data</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the gradient of the input dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;sim&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="n">est</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">beta_</span>
                <span class="n">shape_gradident</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">shape_fit_</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> <span class="n">sim</span><span class="o">.</span><span class="n">beta_</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">gradient</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">shape_gradident</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="s2">&quot;dummy_lr&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># the gradient for categorical features does not exist,</span>
                <span class="c1"># we instead calculate the average difference between the current category and all the other categories.</span>
                <span class="n">gradient</span><span class="p">[:,</span> <span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">est</span><span class="p">[</span><span class="s2">&quot;dummy_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span> <span class="o">-</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> \
                                            <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">est</span><span class="p">[</span><span class="s2">&quot;dummy_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gradient</span>

    <span class="k">def</span> <span class="nf">ice_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cols_per_row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./results/&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ice_visualize&quot;</span><span class="p">,</span> <span class="n">save_png</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_eps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;draw the Individual Conditional Expectation (ICE) plot for the fitted model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">cols_per_row</span><span class="p">,</span> <span class="mf">4.6</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_ids</span> <span class="o">/</span> <span class="n">cols_per_row</span><span class="p">))))</span>
        <span class="n">outer</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_ids</span> <span class="o">/</span> <span class="n">cols_per_row</span><span class="p">)),</span> <span class="n">cols_per_row</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature_indice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span><span class="p">):</span>

            <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_list_</span><span class="p">[</span><span class="n">feature_indice</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">outer</span><span class="p">[</span><span class="n">feature_indice</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">feature_indice</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">feature_indice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">:</span>
                
                <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">xx</span><span class="p">[:,</span> <span class="p">[</span><span class="n">feature_indice</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xgrid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">ygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">feature_indice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_index_list_</span><span class="p">:</span>

                <span class="n">dummy_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
                <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">))</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">xx</span><span class="p">[:,</span> <span class="p">[</span><span class="n">feature_indice</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xgrid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">ygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">)</span>
                <span class="n">input_ticks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span> 
                                  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                <span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_ticks</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">))))</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dummy_values</span><span class="p">[</span><span class="n">i</span><span class="p">])[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_ticks</span><span class="p">]</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">input_ticks</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">input_labels</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ygrid</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">save_eps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.eps&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_png</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_fit_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;fit the categorical variables by one-hot encoding and linear models</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            containing target values</span>
<span class="sd">        sample_weight : array-like of shape (n_samples,), optional</span>
<span class="sd">            containing sample weights</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">transformer_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">indice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span><span class="p">):</span>
            
            <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_list_</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span>
            <span class="n">feature_indice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_index_list_</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span>
            
            <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">feature_indice</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">])))</span>
            <span class="n">density</span><span class="p">[</span><span class="n">unique</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_density_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">feature_name</span><span class="p">:{</span><span class="s2">&quot;density&quot;</span><span class="p">:{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">],</span>
                                                                 <span class="s2">&quot;scores&quot;</span><span class="p">:</span><span class="n">density</span><span class="p">}}})</span>

            <span class="n">transformer_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">feature_name</span><span class="p">,</span>
                             <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span>
                             <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)]),</span> <span class="p">[</span><span class="n">feature_indice</span><span class="p">]))</span>
        <span class="n">dummy_estimator_all</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;ohe&quot;</span><span class="p">,</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformer_list</span><span class="p">)),</span> <span class="p">(</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="n">RidgeCV</span><span class="p">())])</span>        
        <span class="n">dummy_estimator_all</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr__sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">indice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span><span class="p">):</span>
           
            <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_list_</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span>
            <span class="n">feature_indice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_index_list_</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span>
            <span class="n">dummy_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
            <span class="n">dummy_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dummy_estimator_all</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]])</span>

            <span class="n">dummy_estimator</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">data</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="n">idx</span><span class="p">]],</span>
                                                <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kw_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="n">feature_indice</span><span class="p">})),</span>
                            <span class="p">(</span><span class="s2">&quot;ohe&quot;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_values_</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)])),</span>
                            <span class="p">(</span><span class="s2">&quot;dummy_lr&quot;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">())])</span>
            <span class="n">dummy_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">dummy_estimator</span><span class="p">[</span><span class="s2">&quot;dummy_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dummy_estimator</span><span class="p">[</span><span class="s2">&quot;dummy_lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="n">dummy_coef</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dummy_estimator</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">+=</span> <span class="n">dummy_estimator_all</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">intercept_</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;fit the SimBoost model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            containing target values</span>
<span class="sd">        sample_weight : array-like of shape (n_samples,), optional</span>
<span class="sd">            containing sample weights</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object </span>
<span class="sd">            self : Estimator instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_hyperparameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_meta_info</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sample_weight</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_density_</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">is_regressor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span><span class="p">,</span>
                                          <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span><span class="p">,</span>
                                          <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pruning</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_cost_</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;output f1(beta1^T x) + f2(beta2^T x) + ... for given samples</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array of shape (n_samples,),</span>
<span class="sd">            containing f1(beta1^T x) + f2(beta2^T x) + ...</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;best_estimators_&quot;</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;sim&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pred</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;dummy_lr&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pred</span> <span class="o">+=</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred</span>


<div class="viewcode-block" id="SimBoostRegressor"><a class="viewcode-back" href="../../apidoc.html#pysim.simboost.SimBoostRegressor">[docs]</a><span class="k">class</span> <span class="nc">SimBoostRegressor</span><span class="p">(</span><span class="n">BaseSimBooster</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for sim boost regression (residual boosting).</span>

<span class="sd">    Training Steps:</span>
<span class="sd">    </span>
<span class="sd">    1. Preprocess all categorical features with one-hot encodeing, and then build a linear model between all the dummy variables and the response. (_fit_dummy) </span>
<span class="sd">    </span>
<span class="sd">    2. Calculate the pseudo residual using logit boost. (_fit)</span>
<span class="sd">    </span>
<span class="sd">    3. Calculate the orthogonal enhancement for the next SIM Regressor (ortho_shrink, only used when learning_rate=1.0). (_fit)</span>
<span class="sd">    </span>
<span class="sd">    4. Fit a SIM Regressor using all numerical features and the pseudo residual. (_fit)</span>
<span class="sd">    </span>
<span class="sd">    5. Recalculate the pseudo residual subject to learning_rate. (_fit)</span>
<span class="sd">    </span>
<span class="sd">    6. Repeat steps 2 - 5 until n_estimators is reached. (_fit)</span>
<span class="sd">    </span>
<span class="sd">    7. Rank the fitted SIM Regressors according to variation they explained. (_pruning)</span>
<span class="sd">    </span>
<span class="sd">    8. Sequentially add the ranked SIM Regressors (starting from top ranked) and evaluate the validation performance. (_pruning)</span>
<span class="sd">    </span>
<span class="sd">    9. Select the best number of SIM Regressors according to the validation performance. (_pruning)</span>
<span class="sd">    </span>
<span class="sd">    10. Interpretation: the pruning procedure (validation_performance), global model (visualize), local interpretation (local_visualize and ice_visualize).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_estimators : int</span>
<span class="sd">        The maximum number of estimators for boosing</span>

<span class="sd">    stein_method : str, optional. default=&quot;first_order&quot;</span>
<span class="sd">        The base method for estimating the projection coefficients in sparse SIM</span>
<span class="sd">        </span>
<span class="sd">        &quot;first_order&quot;: First-order Stein&#39;s Identity via sparse PCA solver</span>

<span class="sd">        &quot;second_order&quot;: Second-order Stein&#39;s Identity via sparse PCA solver</span>

<span class="sd">        &quot;first_order_thres&quot;: First-order Stein&#39;s Identity via hard thresholding (A simplified verison)     </span>

<span class="sd">        &quot;ols&quot;: Least squares estimation subject to hard thresholding.</span>

<span class="sd">    spline : str, optional. default=&quot;smoothing_spline&quot;</span>
<span class="sd">        The type of spline for fitting the curve</span>
<span class="sd">      </span>
<span class="sd">        &quot;smoothing_spline&quot;: Smoothing spline</span>

<span class="sd">        &quot;p_spline&quot;: P-spline</span>

<span class="sd">        &quot;mono_p_spline&quot;: P-spline with monotonic constraint</span>

<span class="sd">        &quot;a_spline&quot;: Adaptive B-spline</span>

<span class="sd">    knot_dist : str, optional. default=&quot;uniform&quot;</span>
<span class="sd">        Distribution of knots</span>
<span class="sd">      </span>
<span class="sd">        &quot;uniform&quot;: uniformly over the domain</span>

<span class="sd">        &quot;quantile&quot;: uniform quantiles of the given input data (not available when spline=&quot;p_spline&quot; or &quot;mono_p_spline&quot;)</span>

<span class="sd">    learning_rate : float, optional. default=1.0</span>
<span class="sd">        The learning rate controling the shrinkage when performing boosting, ranges from 0 to 1</span>

<span class="sd">    reg_lambda : float, optional. default=0.1</span>
<span class="sd">        The sparsity strength of projection inidce, ranges from 0 to 1 </span>

<span class="sd">    reg_gamma : float, optional. default=0.1</span>
<span class="sd">        The roughness penalty strength of the spline algorithm</span>
<span class="sd">    </span>
<span class="sd">        For spline=&quot;smoothing_spline&quot;, it ranges from 0 to 1 </span>

<span class="sd">        For spline=&quot;p_spline&quot;,&quot;mono_p_spline&quot; or &quot;a_spline&quot;, it ranges from 0 to :math:`+\infty`</span>
<span class="sd">    </span>
<span class="sd">    degree : int, optional. default=2</span>
<span class="sd">        The order of the spline, not used for spline=&quot;smoothing_spline&quot;</span>
<span class="sd">    </span>
<span class="sd">    knot_num : int, optional. default=20</span>
<span class="sd">        Number of knots</span>
<span class="sd">    </span>
<span class="sd">    ortho_shrink : float, optional. default=1</span>
<span class="sd">        Shrinkage strength for orthogonal enhancement, ranges from 0 to 1, valid when learning_rage=1.0</span>

<span class="sd">    loss_threshold : float, optional. default=0.01</span>
<span class="sd">        This parameter is used for post-hoc pruning, ranges from 0 to 1</span>
<span class="sd">        To reduce model complexity, we prefer to use fewer base learners, which is as accurate as (1 - loss_threshold) of the best performance)</span>

<span class="sd">    inner_update : bool, optional. default=True</span>
<span class="sd">        Whether to perform inner update for each base learner</span>

<span class="sd">    meta_info : None or a dict with features&#39; information</span>
<span class="sd">        It has two types:</span>

<span class="sd">        continuous:</span>
<span class="sd">            Specify `Type` as `continuous`, and include the keys of `Range` (a list with lower-upper elements pair) and</span>
<span class="sd">            `Wrapper`, a callable function for wrapping the values.</span>
<span class="sd">        categorical:</span>
<span class="sd">            Specify `Type` as `categorical`, and include the keys of `Mapping` (a list with all the possible categories).</span>

<span class="sd">    val_ratio : float, optional. default=0.2</span>
<span class="sd">        The split ratio of validation set, which is used for post-hoc pruning</span>

<span class="sd">    random_state : int, optional. default=0</span>
<span class="sd">        Random seed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_estimators</span><span class="p">,</span> <span class="n">stein_method</span><span class="o">=</span><span class="s2">&quot;first_order&quot;</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="s2">&quot;a_spline&quot;</span><span class="p">,</span> <span class="n">knot_dist</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reg_lambda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">reg_gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">knot_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">ortho_shrink</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loss_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">inner_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">meta_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SimBoostRegressor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span>
                                   <span class="n">stein_method</span><span class="o">=</span><span class="n">stein_method</span><span class="p">,</span>
                                   <span class="n">spline</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span>
                                   <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                                   <span class="n">reg_lambda</span><span class="o">=</span><span class="n">reg_lambda</span><span class="p">,</span>
                                   <span class="n">reg_gamma</span><span class="o">=</span><span class="n">reg_gamma</span><span class="p">,</span>
                                   <span class="n">knot_dist</span><span class="o">=</span><span class="n">knot_dist</span><span class="p">,</span>
                                   <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span>
                                   <span class="n">knot_num</span><span class="o">=</span><span class="n">knot_num</span><span class="p">,</span>
                                   <span class="n">ortho_shrink</span><span class="o">=</span><span class="n">ortho_shrink</span><span class="p">,</span>
                                   <span class="n">loss_threshold</span><span class="o">=</span><span class="n">loss_threshold</span><span class="p">,</span>
                                   <span class="n">inner_update</span><span class="o">=</span><span class="n">inner_update</span><span class="p">,</span>
                                   <span class="n">meta_info</span><span class="o">=</span><span class="n">meta_info</span><span class="p">,</span>
                                   <span class="n">val_ratio</span><span class="o">=</span><span class="n">val_ratio</span><span class="p">,</span>
                                   <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

<div class="viewcode-block" id="SimBoostRegressor._validate_input"><a class="viewcode-back" href="../../apidoc.html#pysim.simboost.SimBoostRegressor._validate_input">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;method to validate data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">check_X_y</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">accept_sparse</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;csr&quot;</span><span class="p">,</span> <span class="s2">&quot;csc&quot;</span><span class="p">,</span> <span class="s2">&quot;coo&quot;</span><span class="p">],</span>
                         <span class="n">multi_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y_numeric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimBoostRegressor._fit"><a class="viewcode-back" href="../../apidoc.html#pysim.simboost.SimBoostRegressor._fit">[docs]</a>    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
   
        <span class="sd">&quot;&quot;&quot;fit the SimBoost model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            containing target values</span>
<span class="sd">        sample_weight : array-like of shape (n_samples,), optional</span>
<span class="sd">            containing sample weights</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val_fold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_samples</span><span class="p">))</span>
        <span class="n">val_fold</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="c1"># Initialize the intercept</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span>

        <span class="c1"># Fit categorical variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_dummy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span>
        
        <span class="c1"># Fit Sim Boosting for numerical variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> 
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">):</span>

            <span class="c1"># projection matrix</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ortho_shrink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">proj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">projection_indices_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">est</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">beta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">u</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">projection_indices_</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">proj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ortho_shrink</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proj_mat</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># fit Sim estimator</span>
            <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stein_method_list</span><span class="p">,</span> 
                      <span class="s2">&quot;reg_lambda&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda_list</span><span class="p">,</span>
                      <span class="s2">&quot;reg_gamma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma_list</span><span class="p">}</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">SimRegressor</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">knot_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">,</span>
                                  <span class="n">knot_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knot_dist</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">),</span> 
                         <span class="n">scoring</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">False</span><span class="p">)},</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">cv</span><span class="o">=</span><span class="n">PredefinedSplit</span><span class="p">(</span><span class="n">val_fold</span><span class="p">),</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> <span class="n">z</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">proj_mat</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">)</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">grid</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">grid</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;rank_test_mse&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">sim_estimator</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                                  <span class="p">(</span><span class="s2">&quot;sim&quot;</span><span class="p">,</span> <span class="n">sim</span><span class="p">)])</span>
            
            <span class="n">sim_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span>
                       <span class="n">sim__sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">sim__proj_mat</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_update</span><span class="p">:</span>
                <span class="n">sim_estimator</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_inner_update</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> <span class="n">z</span><span class="p">,</span> 
                        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">proj_mat</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span>
                        <span class="n">n_inner_iter_no_change</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">n_samples</span><span class="p">)),</span> <span class="n">val_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span><span class="p">)</span>
            <span class="c1"># update    </span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">sim_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_estimator</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimBoostRegressor._pruning"><a class="viewcode-back" href="../../apidoc.html#pysim.simboost.SimBoostRegressor._pruning">[docs]</a>    <span class="k">def</span> <span class="nf">_pruning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
          
        <span class="sd">&quot;&quot;&quot;prune the base learners that are not importnat</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples, 1)</span>
<span class="sd">            containing the output dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">component_importance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="p">):</span>
            <span class="n">component_importance</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;sim &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">indice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sim&quot;</span><span class="p">,</span> <span class="s2">&quot;indice&quot;</span><span class="p">:</span> <span class="n">indice</span><span class="p">,</span>
                                 <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">,</span> <span class="p">:]))}})</span>

        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">):</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">component_importance</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">feature_name</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy_lr&quot;</span><span class="p">,</span> <span class="s2">&quot;indice&quot;</span><span class="p">:</span> <span class="n">indice</span><span class="p">,</span>
                                 <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">,</span> <span class="p">:]))}})</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pred_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">pred_val</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">component_importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;importance&quot;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sim&quot;</span><span class="p">:</span>
                <span class="n">est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;indice&quot;</span><span class="p">]]</span>
                <span class="n">pred_val</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dummy_lr&quot;</span><span class="p">:</span>
                <span class="n">est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;indice&quot;</span><span class="p">]]</span>
                <span class="n">pred_val</span> <span class="o">+=</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">pred_val</span><span class="p">))</span>

        <span class="n">best_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span> <span class="o">/</span> <span class="n">best_loss</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span> <span class="o">/</span> <span class="n">best_loss</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_mse_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[:</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_importance_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">component_importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;importance&quot;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">best_idx</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_cfeature_index_</span> <span class="o">=</span> <span class="p">[</span><span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="k">if</span> <span class="s2">&quot;dummy_lr&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

<div class="viewcode-block" id="SimBoostRegressor.predict"><a class="viewcode-back" href="../../apidoc.html#pysim.simboost.SimBoostRegressor.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;output prediction for given samples</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array of shape (n_samples,)</span>
<span class="sd">            containing prediction</span>
<span class="sd">        &quot;&quot;&quot;</span>  

        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred</span></div></div>
    
    
<span class="k">class</span> <span class="nc">SimBoostClassifier</span><span class="p">(</span><span class="n">BaseSimBooster</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for sim boost classification (logit boost).</span>

<span class="sd">    Training Steps:</span>
<span class="sd">    1. Preprocess all categorical features with one-hot encodeing, and then build a linear model between all the dummy variables and the response. (_fit_dummy)</span>
<span class="sd">    2. Calculate the pseudo residual using logit boost. (_fit)</span>
<span class="sd">    3. Calculate the orthogonal enhancement for the next SIM Regressor (ortho_shrink, only used when learning_rate=1.0). (_fit)</span>
<span class="sd">    4. Fit a SIM Regressor using all numerical features and the pseudo residual. (_fit)</span>
<span class="sd">    5. Recalculate the pseudo residual subject to learning_rate. (_fit)</span>
<span class="sd">    6. Repeat steps 2 - 5 until n_estimators is reached. (_fit)</span>
<span class="sd">    7. Rank the fitted SIM Regressors according to variation they explained. (_pruning)</span>
<span class="sd">    8. Sequentially add the ranked SIM Regressors (starting from top ranked) and evaluate the validation performance. (_pruning)</span>
<span class="sd">    9. Select the best number of SIM Regressors according to the validation performance. (_pruning)</span>
<span class="sd">    10. Interpretation: the pruning procedure (validation_performance), global model (visualize), local interpretation (local_visualize and ice_visualize).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_estimators : int</span>
<span class="sd">        The maximum number of estimators for boosing</span>

<span class="sd">    stein_method : str, optional. default=&quot;first_order&quot;</span>
<span class="sd">        The base method for estimating the projection coefficients in sparse SIM</span>
<span class="sd">        </span>
<span class="sd">        &quot;first_order&quot;: First-order Stein&#39;s Identity via sparse PCA solver</span>

<span class="sd">        &quot;second_order&quot;: Second-order Stein&#39;s Identity via sparse PCA solver</span>

<span class="sd">        &quot;first_order_thres&quot;: First-order Stein&#39;s Identity via hard thresholding (A simplified verison)     </span>

<span class="sd">        &quot;ols&quot;: Least squares estimation subject to hard thresholding.</span>

<span class="sd">    spline : str, optional. default=&quot;smoothing_spline&quot;</span>
<span class="sd">        The type of spline for fitting the curve</span>
<span class="sd">      </span>
<span class="sd">        &quot;smoothing_spline&quot;: Smoothing spline</span>

<span class="sd">        &quot;p_spline&quot;: P-spline</span>

<span class="sd">        &quot;mono_p_spline&quot;: P-spline with monotonic constraint</span>

<span class="sd">        &quot;a_spline&quot;: Adaptive B-spline</span>

<span class="sd">    knot_dist : str, optional. default=&quot;uniform&quot;</span>
<span class="sd">        Distribution of knots</span>
<span class="sd">      </span>
<span class="sd">        &quot;uniform&quot;: uniformly over the domain</span>

<span class="sd">        &quot;quantile&quot;: uniform quantiles of the given input data (not available when spline=&quot;p_spline&quot; or &quot;mono_p_spline&quot;)</span>

<span class="sd">    learning_rate : float, optional. default=1.0</span>
<span class="sd">        The learning rate controling the shrinkage when performing boosting, ranges from 0 to 1</span>

<span class="sd">    reg_lambda : float, optional. default=0.1</span>
<span class="sd">        The sparsity strength of projection inidce, ranges from 0 to 1 </span>

<span class="sd">    reg_gamma : float, optional. default=0.1</span>
<span class="sd">        The roughness penalty strength of the spline algorithm</span>
<span class="sd">    </span>
<span class="sd">        For spline=&quot;smoothing_spline&quot;, it ranges from 0 to 1 </span>

<span class="sd">        For spline=&quot;p_spline&quot;,&quot;mono_p_spline&quot; or &quot;a_spline&quot;, it ranges from 0 to :math:`+\infty`</span>
<span class="sd">    </span>
<span class="sd">    degree : int, optional. default=2</span>
<span class="sd">        The order of the spline, not used for spline=&quot;smoothing_spline&quot;</span>
<span class="sd">    </span>
<span class="sd">    knot_num : int, optional. default=20</span>
<span class="sd">        Number of knots</span>
<span class="sd">    </span>
<span class="sd">    ortho_shrink : float, optional. default=1</span>
<span class="sd">        Shrinkage strength for orthogonal enhancement, ranges from 0 to 1, valid when learning_rage=1.0</span>

<span class="sd">    loss_threshold : float, optional. default=0.01</span>
<span class="sd">        This parameter is used for post-hoc pruning, ranges from 0 to 1</span>
<span class="sd">        To reduce model complexity, we prefer to use fewer base learners, which is as accurate as (1 - loss_threshold) of the best performance)</span>

<span class="sd">    inner_update : bool, optional. default=True</span>
<span class="sd">        Whether to perform inner update for each base learner</span>

<span class="sd">    meta_info : None or a dict with features&#39; information</span>
<span class="sd">        It has two types:</span>

<span class="sd">        continuous:</span>
<span class="sd">            Specify `Type` as `continuous`, and include the keys of `Range` (a list with lower-upper elements pair) and</span>
<span class="sd">            `Wrapper`, a callable function for wrapping the values.</span>
<span class="sd">        categorical:</span>
<span class="sd">            Specify `Type` as `categorical`, and include the keys of `Mapping` (a list with all the possible categories).</span>

<span class="sd">    val_ratio : float, optional. default=0.2</span>
<span class="sd">        The split ratio of validation set, which is used for post-hoc pruning</span>

<span class="sd">    random_state : int, optional. default=0</span>
<span class="sd">        Random seed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_estimators</span><span class="p">,</span> <span class="n">stein_method</span><span class="o">=</span><span class="s2">&quot;first_order&quot;</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="s2">&quot;a_spline&quot;</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reg_lambda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">reg_gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">knot_dist</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">knot_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ortho_shrink</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">loss_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inner_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">meta_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SimBoostClassifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span>
                                   <span class="n">stein_method</span><span class="o">=</span><span class="n">stein_method</span><span class="p">,</span>
                                   <span class="n">spline</span><span class="o">=</span><span class="n">spline</span><span class="p">,</span>
                                   <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                                   <span class="n">reg_lambda</span><span class="o">=</span><span class="n">reg_lambda</span><span class="p">,</span>
                                   <span class="n">reg_gamma</span><span class="o">=</span><span class="n">reg_gamma</span><span class="p">,</span>
                                   <span class="n">knot_dist</span><span class="o">=</span><span class="n">knot_dist</span><span class="p">,</span>
                                   <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span>
                                   <span class="n">knot_num</span><span class="o">=</span><span class="n">knot_num</span><span class="p">,</span>
                                   <span class="n">ortho_shrink</span><span class="o">=</span><span class="n">ortho_shrink</span><span class="p">,</span>
                                   <span class="n">loss_threshold</span><span class="o">=</span><span class="n">loss_threshold</span><span class="p">,</span>
                                   <span class="n">inner_update</span><span class="o">=</span><span class="n">inner_update</span><span class="p">,</span>
                                   <span class="n">meta_info</span><span class="o">=</span><span class="n">meta_info</span><span class="p">,</span>
                                   <span class="n">val_ratio</span><span class="o">=</span><span class="n">val_ratio</span><span class="p">,</span>
                                   <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;method to validate data</span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            containing target values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">check_X_y</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">accept_sparse</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;csr&quot;</span><span class="p">,</span> <span class="s2">&quot;csc&quot;</span><span class="p">,</span> <span class="s2">&quot;coo&quot;</span><span class="p">],</span>
                         <span class="n">multi_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">column_or_1d</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_label_binarizer</span> <span class="o">=</span> <span class="n">LabelBinarizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label_binarizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label_binarizer</span><span class="o">.</span><span class="n">classes_</span>

        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label_binarizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;fit the SimBoost model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            containing target values</span>
<span class="sd">        sample_weight : array-like of shape (n_samples,), optional</span>
<span class="sd">            containing sample weights</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val_fold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_samples</span><span class="p">))</span>
        <span class="n">val_fold</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="c1"># Initialize the intercept</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">pred_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">))</span>
        <span class="n">pred_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">))</span>
        <span class="n">proba_train</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
        <span class="n">proba_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_val</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>

        <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">proba_train</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba_train</span><span class="p">)</span>
        <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">])</span>
        <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">proba_train</span><span class="p">,</span> <span class="n">proba_val</span><span class="p">]),</span>
                            <span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">proba_train</span><span class="p">,</span> <span class="n">proba_val</span><span class="p">])))</span> 
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=-</span><span class="mi">8</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Fit categorical variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfeature_num_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_dummy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">])</span>
            <span class="n">pred_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span>
            <span class="n">proba_train</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
            <span class="n">pred_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span>
            <span class="n">proba_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_val</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>

        <span class="c1"># Fit Sim Boosting for numerical variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> 

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">):</span>
            <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">proba_train</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">proba_train</span><span class="p">)</span>
            <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">])</span>
            <span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">proba_train</span><span class="p">,</span> <span class="n">proba_val</span><span class="p">]),</span>
                                <span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">proba_train</span><span class="p">,</span> <span class="n">proba_val</span><span class="p">])))</span> 
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=-</span><span class="mi">8</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

            <span class="c1"># projection matrix</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ortho_shrink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">proj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfeature_num_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">projection_indices_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">est</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">beta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">u</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">projection_indices_</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">proj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ortho_shrink</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proj_mat</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># fit Sim estimator</span>
            <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stein_method_list</span><span class="p">,</span> 
                      <span class="s2">&quot;reg_lambda&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda_list</span><span class="p">,</span>
                      <span class="s2">&quot;reg_gamma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_gamma_list</span><span class="p">}</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">SimRegressor</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">knot_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knot_num</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">,</span>
                                  <span class="n">knot_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knot_dist</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">),</span> 
                          <span class="n">scoring</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">False</span><span class="p">)},</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">cv</span><span class="o">=</span><span class="n">PredefinedSplit</span><span class="p">(</span><span class="n">val_fold</span><span class="p">),</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">error_score</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> <span class="n">z</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">proj_mat</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">)</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">grid</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">grid</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;rank_test_mse&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">sim_estimator</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> 
                                                        <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                                   <span class="p">(</span><span class="s2">&quot;sim&quot;</span><span class="p">,</span> <span class="n">sim</span><span class="p">)])</span>
            <span class="n">sim_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span>
                        <span class="n">sim__sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">sim__proj_mat</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">)</span>

            <span class="c1"># update</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_update</span><span class="p">:</span>
                <span class="n">sim_estimator</span><span class="p">[</span><span class="s2">&quot;sim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_inner_update</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfeature_index_list_</span><span class="p">],</span> <span class="n">z</span><span class="p">,</span> 
                        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">proj_mat</span><span class="o">=</span><span class="n">proj_mat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span>
                        <span class="n">n_inner_iter_no_change</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">n_samples</span><span class="p">)),</span> <span class="n">val_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ratio</span><span class="p">)</span>
            <span class="n">pred_train</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">sim_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">])</span>
            <span class="n">proba_train</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
            <span class="n">pred_val</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">sim_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span>
            <span class="n">proba_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_val</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_estimator</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_pruning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
          
        <span class="sd">&quot;&quot;&quot;prune the base learners that are not importnat</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        y : array-like of shape (n_samples, 1)</span>
<span class="sd">            containing the output dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">component_importance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="p">):</span>
            <span class="n">component_importance</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;sim &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">indice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sim&quot;</span><span class="p">,</span> <span class="s2">&quot;indice&quot;</span><span class="p">:</span> <span class="n">indice</span><span class="p">,</span>
                                <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">,</span> <span class="p">:]))}})</span>

        <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">):</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">component_importance</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">feature_name</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy_lr&quot;</span><span class="p">,</span> <span class="s2">&quot;indice&quot;</span><span class="p">:</span> <span class="n">indice</span><span class="p">,</span>
                                <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_idx</span><span class="p">,</span> <span class="p">:]))}})</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pred_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">))</span>
        <span class="n">proba_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_val</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span> <span class="o">=</span> <span class="p">[</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">pred_val</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">component_importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;importance&quot;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sim&quot;</span><span class="p">:</span>
                <span class="n">est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_estimators_</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;indice&quot;</span><span class="p">]]</span>
                <span class="n">pred_val</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dummy_lr&quot;</span><span class="p">:</span>
                <span class="n">est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_estimators_</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;indice&quot;</span><span class="p">]]</span>
                <span class="n">pred_val</span> <span class="o">+=</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est</span><span class="p">)</span>
            <span class="n">pred_val</span> <span class="o">+=</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">])</span>
            <span class="n">proba_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pred_val</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">proba_val</span><span class="p">))</span>

        <span class="n">best_auc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span> <span class="o">/</span> <span class="n">best_auc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span> <span class="o">/</span> <span class="n">best_auc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_auc_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[:</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_importance_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">component_importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;importance&quot;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">best_idx</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_cfeature_index_</span> <span class="o">=</span> <span class="p">[</span><span class="n">est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_estimators_</span> <span class="k">if</span> <span class="s2">&quot;dummy_lr&quot;</span> <span class="ow">in</span> <span class="n">est</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;output probability prediction for given samples</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array of shape (n_samples,)</span>
<span class="sd">            containing probability prediction</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pred_proba</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="o">-</span><span class="n">pred</span><span class="p">,</span> <span class="n">pred</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pred_proba</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;output binary prediction for given samples</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        x : array-like of shape (n_samples, n_features)</span>
<span class="sd">            containing the input dataset</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array of shape (n_samples,)</span>
<span class="sd">            containing binary prediction</span>
<span class="sd">        &quot;&quot;&quot;</span>  

        <span class="n">pred_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label_binarizer</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_proba</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Zebin Yang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>